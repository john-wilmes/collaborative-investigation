#!/bin/sh
set -eu

# Pre-commit hook for collaborative-investigation.
# 1. Rejects EVIDENCE/ files from staging (local-only raw data)
# 2. Runs PHI sanitization on staged BRIEF.md, FINDINGS.md, and STATUS.md files
#
# Install: copy to .git/hooks/pre-commit or run:
#   git config core.hooksPath .githooks

ROOT_DIR="$(git rev-parse --show-toplevel)"
SANITIZE_SCRIPT="$ROOT_DIR/scripts/sanitize.sh"

EXIT_CODE=0
STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACM)"

# --- Local-Only File Guard ---
while IFS= read -r file; do
    [ -z "$file" ] && continue
    case "$file" in
        */EVIDENCE/*)
            echo "Error: $file must not be committed (local-only raw data)" >&2
            EXIT_CODE=1
            ;;
    esac
done <<EOF
$STAGED_FILES
EOF

if [ "$EXIT_CODE" -ne 0 ]; then
    echo "Unstage EVIDENCE/ files before committing." >&2
    exit $EXIT_CODE
fi

# --- PHI Sanitization ---
set --
while IFS= read -r file; do
    [ -z "$file" ] && continue
    case "$file" in
        */BRIEF.md|*/FINDINGS.md|*/STATUS.md)
            set -- "$@" "$ROOT_DIR/$file"
            ;;
    esac
done <<EOF
$STAGED_FILES
EOF

if [ "$#" -gt 0 ] && [ -x "$SANITIZE_SCRIPT" ]; then
    "$SANITIZE_SCRIPT" "$@" || true

    # Re-stage sanitized files
    for file in "$@"; do
        git add "$file"
    done
fi

exit $EXIT_CODE
